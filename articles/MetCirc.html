<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetCirc: Navigating mass spectral similarity in high-resolution MS/MS metabolomics data • MetCirc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MetCirc: Navigating mass spectral similarity in high-resolution MS/MS metabolomics data">
<meta property="og:description" content="MetCirc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MetCirc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.27.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/MetCirc.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MetCirc: Navigating mass spectral similarity in
high-resolution MS/MS metabolomics data</h1>
                        <h4 data-toc-skip class="author">Thomas Naake
and Emmanuel Gaquerel</h4>
            <address class="author_afil">
      European Molecular Biology Laboratory, 69117 Heidelberg, Germany;
Institut de biologie mol'{e}culaire du m'{e}tabolisme des plantes,
Universit'{e} de Strasbourg, 67084 Strasbourg,
France<br><div class="hidden name"><code>MetCirc.Rmd</code></div>

    </address>
</div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>MetCirc</code> package comprises functionalities to
display, (interactively) explore similarities and annotate features of
MS/MS metabolomics data. It is especially designed to improve the
interactive exploration of metabolomics data obtained from
cross-species/cross-tissues comparative experiments.
<code>MetCirc</code> relies on the <code>Spectra</code> infrastructure
to handle MS/MS spectra. Specifically, <code>MetCirc</code> uses the
Spectra<code>class from which similarities  between features are calculated and which stores  information on spectra in the columns of the slot</code>metadata`.</p>
<p>Notably, <code>MetCirc</code> provides functions to calculate the
similarity between individual MS/MS spectra based on a normalised dot
product (NDP, see <span class="citation">Li, Baldwin, and Gaquerel
(2015)</span> for further details) calculation taking into account
shared fragments or main neutral losses.</p>
<p>Visualisation of molecular networks was pioneered by the Dorrestein
lab <span class="citation">(Watrous et al. 2012)</span> to efficiently
organize MS/MS spectra in such a way that clusters of MS/MS spectra
sharing multiple common fragments are rapidly inferred.</p>
<p>In contrary to the analysis there, the <code>MetCirc</code> framework
offers two ways for the computation of mass spectrum similarity: one way
deploys common (shared) fragments and the other shared neutral losses
that are deduced from the spectra. Especially the latter approach allows
to extract clusters of spectra corresponding to compound families
facilitating the rapid dereplication of hitherto unknown metabolites.
Small molecules, as produced by plants, return during fragmentation few
fragments.<br>
Sometimes only a few fragments among them are shared and diagnostic
across the compound family. Compared to the MS/MS similarity scoring
based on shared fragments, the second similarity measure incorporates,
in a non-supervised manner, neutral losses, which definitely helps
obtaining biochemically-meaningful MS/MS groupings. Furthermore, any
other function to calculate similarities can be provided or a similarity
matrix providing similarity (in the range from 0 to 1) for features that
are present in the <code>Spectra</code> object.</p>
<p>The interpretation drawn from network reconstruction highly depends
from topological parameters applied during the network construction
steps. <code>MetCirc</code> circumvents this confinement. Furthermore,
it uses instead smaller MS/MS datasets obtained from experiments
involving <em>a priori</em> defined biological groups (organisms,
tissues, etc.) to visualize within and between MS/MS feature
similarities on a circular layout - inspired by the Circos framework
<span class="citation">(Krzywinski et al. 2009)</span>. The
visualisation is adjustable (MS/MS ordering and similarity thresholds)
via the <code>shiny</code> interface and does not uniquely emphasize on
large clusters of MS/MS features (a frequent caveat of network
visualisation). Furthermore, the implemented functionality for
annotation may improve dereplication of known and unknown molecules.</p>
<p>This vignette uses as a case study indiscriminant MS/MS (idMS/MS)
data from <span class="citation">Li, Baldwin, and Gaquerel
(2015)</span>, unpublished idMS/MS data collected from different organs
of tobacco flowers and data from the Global Natural Product Social
Molecular Networking (GNPS) library to navigate through the analysis
pipeline. The pipeline includes the creation of <code>Spectra</code>
objects, the calculation of a similarity measure (NDP), assignment to a
similarity matrix and visualisation of similarity based on interactive
and non-interactive graphical tools using the <code>circlize</code>
framework <span class="citation">(Gu et al. 2014)</span>.</p>
<p><code>MetCirc</code> is currently under active development. If you
discover any bugs, typos or develop ideas of improving
<code>MetCirc</code> feel free to raise an issue via <a href="https://github.com/tnaake/MetCirc" class="external-link">GitHub</a> or send a mail to
the developers.</p>
</div>
<div class="section level2">
<h2 id="prepare-the-environment">Prepare the environment<a class="anchor" aria-label="anchor" href="#prepare-the-environment"></a>
</h2>
<p>To install <code>MetCirc</code> enter the following to the
<code>R</code> console</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"MetCirc"</span><span class="op">)</span></span></code></pre></div>
<p>Before starting, load the <code>MetCirc</code> package. This will
also load the required packages <code>Spectra</code>,
<code>circlize</code>, <code>amap</code>, <code>scales</code> and
<code>shiny</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"MetCirc"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/RforMassSpectrometry/MsCoreUtils" class="external-link">"MsCoreUtils"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'MsCoreUtils'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:Spectra':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     bin, smooth</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:ProtGenerics':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     bin, smooth</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     smooth</span></span></code></pre>
<p>The central infrastructure class of the <code>MetCirc</code> package
is the <code>Spectra</code> object. The <code>Spectra</code> objects
stores information on precursor m/z, retention time, m/z and intensity
values of fragments and possible additional information, e.g. to which
class the MS/MS feature belong to, the identity of the MS/MS feature,
information on the adduct of the precursor, additional information.
Furthermore, the <code>Spectra</code> object can host information under
which condition (in which tissue, etc.) the MS/MS feature was
detected.</p>
<p>We provide here three examplary workflows to create
<code>Spectra</code> from data frames that are loaded into R: (1) by
loading a data frame with a minimum requirement of a column “id”
(comprising unique identifiers for MS/MS features) and of the columns
“mz” and “intensity” comprising the fragment ions and their intensities,
respectively, or (2) by loading a data frame resembling a .MSP file
object.</p>
<div class="section level3">
<h3 id="load-example-data-sets-from-li2015-tissue-idmsms-data-and-gnps-data">Load example data sets from <span class="citation">Li, Baldwin, and
Gaquerel (2015)</span>, tissue idMS/MS data and GNPS data<a class="anchor" aria-label="anchor" href="#load-example-data-sets-from-li2015-tissue-idmsms-data-and-gnps-data"></a>
</h3>
<p>sd02_deconvoluted comprises 360 idMS/MS deconvoluted spectra with
fragment ions (m/z, chromatographic retention time, relative intensity
in %) and a column with unique identifiers for MS/MS features (here, the
corresponding principal component group with the precursor ion). The
data set is derived from the study of <span class="citation">Li,
Baldwin, and Gaquerel (2015)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load data from Li et al., 2015</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"sd02_deconvoluted"</span>, package <span class="op">=</span> <span class="st">"MetCirc"</span><span class="op">)</span></span></code></pre></div>
<p>The second data set comes from the data-independent MS/MS collection
of different floral organs from tobacco plants. Using our pipeline, this
data set will be used to visualize shared metabolites between tissues as
well as structural relationships among within- and between-organ MS/MS
spectra. MS/MS data are merged across floral organs in one unique data
file <code>idMSMStissueproject.Rdata</code> as <code>tissue</code>.
Information on the organ-localisation of each MS/MS spectrum is stored
in<br><code>compartmentTissue</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load idMSMStissueproject</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"idMSMStissueproject"</span>, package <span class="op">=</span> <span class="st">"MetCirc"</span><span class="op">)</span></span></code></pre></div>
<p>The third data set comes from the GNPS data base (downloaded at
February 11, 2017 from: \ <a href="http://prime.psc.riken.jp/Metabolomics_Software/MS-DIAL/MSMS-GNPS-Curated-Neg.msp" class="external-link">http://prime.psc.riken.jp/Metabolomics_Software/MS-DIAL/MSMS-GNPS-Curated-Neg.msp</a>).
It contains 22 MS/MS features (a truncated file of the original one) and
is formatted in the .MSP file format, a typical format for MS/MS
libraries. The MS/MS spectra are (normally) separated by blank lines and
give information on the metabolite (its name, precursor m/z value,
retention time, class, adduct ion) and contain additional
information.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load data from GNPS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"convertMsp2Spectra"</span>, package <span class="op">=</span> <span class="st">"MetCirc"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="prepare-data-for-mass-spectral-similarity-calculations">Prepare data for mass spectral similarity calculations<a class="anchor" aria-label="anchor" href="#prepare-data-for-mass-spectral-similarity-calculations"></a>
</h2>
<div class="section level3">
<h3 id="preparing-the-sd02_deconvoluted-data-set-for-analysis">Preparing the sd02_deconvoluted data set for analysis<a class="anchor" aria-label="anchor" href="#preparing-the-sd02_deconvoluted-data-set-for-analysis"></a>
</h3>
<p>Here, we convert the examplatory data from <span class="citation">Li,
Baldwin, and Gaquerel (2015)</span> into a <code>Spectra</code> object
that is later used as the input for mass spectral similarity
calculations. Data in the form of the data frame sd02_deconvoluted
require columns that store the m/z values of fragments, the intensity
values for the respective fragments and a column containing an “id”. The
latter column contains information about the precursor ion and should be
a unique descriptor for the MS/MS features. For instance, this column
may be the derived from the output of the
<code>xcms</code>/<code>CAMERA</code> processing creating unique
identifiers for each metabolite decoded in the column “pcgroup”. A
pcgroup is defined as a peak correlation group obtained by this
workflow. It corresponds to a MS or MS/MS spectrum deconvoluted by
<code>CAMERA</code> and contains information about the precursor
identity and its isotope cluster. The column “id” may additionally
contain information about the precursor retention time.</p>
<p>Create <code>Spectra</code> object from the data of <span class="citation">Li, Baldwin, and Gaquerel (2015)</span>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get all MS/MS spectra</span></span>
<span><span class="va">id_uniq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">sd02_deconvoluted</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain precursor m/z from id_uniq</span></span>
<span><span class="va">prec_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id_uniq</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" _ "</span><span class="op">)</span>, <span class="st">"["</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain m/z from fragments per precursor m/z</span></span>
<span><span class="va">mz_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, </span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">id_i</span><span class="op">)</span> <span class="va">sd02_deconvoluted</span><span class="op">[</span><span class="va">sd02_deconvoluted</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">id_i</span>, <span class="st">"mz"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain corresponding intensity values </span></span>
<span><span class="va">int_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, </span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">id_i</span><span class="op">)</span> <span class="va">sd02_deconvoluted</span><span class="op">[</span><span class="va">sd02_deconvoluted</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">id_i</span>, <span class="st">"intensity"</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## obtain retention time by averaging all retention time values</span></span>
<span><span class="va">rt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">sd02_deconvoluted</span><span class="op">[</span><span class="va">sd02_deconvoluted</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">x</span>, <span class="st">"rt"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create list of Spectra objects, concatenate, and add metadata</span></span>
<span><span class="va">sps_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu">S4Vectors</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>        rtime <span class="op">=</span> <span class="va">rt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        msLevel <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>        precursorMz <span class="op">=</span> <span class="va">prec_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">spd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">spd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">int_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu">Spectra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">spd</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sps_li</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">sps_l</span><span class="op">)</span></span>
<span><span class="va">sps_li</span><span class="op">@</span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>show <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_l</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Furthermore, further columns in the <code>data.frame</code> passed to
<code>metadata</code> can be specified to host additional information,
e.g. metabolite name (column “names”) and classes (column “classes”),
adduct ion names (column “adduct”), further information (column
“information”).</p>
</div>
<div class="section level3">
<h3 id="preparing-the-floral-organ-data-set-for-analysis">Preparing the floral organ data set for analysis<a class="anchor" aria-label="anchor" href="#preparing-the-floral-organ-data-set-for-analysis"></a>
</h3>
<p>We would like to restrict the proof-of-function analysis to four
tissues (sepal, SPL; limb, LIM; anther, ANT; style, STY). We will
truncate <code>tissue</code> in order that it contains only these
instances belonging to these types of tissue. In a next step, we will
create a <code>Spectra</code>-object, <code>spl</code> with information
concerning if the MS/MS features are found in the tissues SPL, LIM, ANT
and STY.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get all MS/MS spectra</span></span>
<span><span class="va">tissue</span> <span class="op">&lt;-</span> <span class="va">tissue</span><span class="op">[</span><span class="va">tissue</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">compartmentTissue</span><span class="op">[</span>, <span class="st">"mz_rt_pcgroup"</span><span class="op">]</span>, <span class="op">]</span></span>
<span><span class="va">id_uniq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tissue</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain precursor m/z from id_uniq</span></span>
<span><span class="va">prec_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id_uniq</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>, <span class="st">"["</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain m/z from fragments per precursor m/z</span></span>
<span><span class="va">mz_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id_i</span><span class="op">)</span> <span class="va">tissue</span><span class="op">[</span><span class="va">tissue</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">id_i</span>, <span class="st">"mz"</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## obtain corresponding intensity values</span></span>
<span><span class="va">int_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id_i</span><span class="op">)</span> <span class="va">tissue</span><span class="op">[</span><span class="va">tissue</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">id_i</span>, <span class="st">"intensity"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## order mz and intensity values</span></span>
<span><span class="va">int_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">int_l</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">int_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mz_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## obtain retention time by averaging all retention time values</span></span>
<span><span class="va">rt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">id_uniq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">tissue</span><span class="op">[</span><span class="va">tissue</span><span class="op">[</span>, <span class="st">"id"</span><span class="op">]</span> <span class="op">==</span> <span class="va">x</span>, <span class="st">"rt"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create list of Spectra objects and concatenate</span></span>
<span><span class="va">sps_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu">S4Vectors</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>        rtime <span class="op">=</span> <span class="va">rt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>        msLevel <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>        precursorMz <span class="op">=</span> <span class="va">prec_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">spd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mz_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">spd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">int_l</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu">Spectra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">spd</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sps_tissue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">sps_l</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## add metadata</span></span>
<span><span class="co">## use SPL, LIM, ANT, STY for further analysis</span></span>
<span><span class="va">sps_tissue</span><span class="op">@</span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="va">compartmentTissue</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SPL"</span>, <span class="st">"LIM"</span>, <span class="st">"ANT"</span>, <span class="st">"STY"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preparing-the-gnps-data-set-for-analysis">Preparing the GNPS data set for analysis<a class="anchor" aria-label="anchor" href="#preparing-the-gnps-data-set-for-analysis"></a>
</h3>
<p>Alternatively as mentioned above, an <code>Spectra</code>-object can
also created from .MSP objects, that are typical data formats for
storing MS/MS libraries. Required properties of such a data frame are
the name of the metabolite (row entry “NAME:”), the m/z value of the
precursor ion (“PRECURSORMZ” or “EXACTMASS:”), retention time
(“RETENTIONTIME:”), information on the number of peaks (“Num Peaks:”)
and information on fragments and peak areas (for further information see
<code>convertMsp2Spectra</code> and retrieve
<code>data("convertMsp2Spectra", package = "MetCirc")</code> for a
typical msp data frame).</p>
<p>Create <code>Spectra</code>-object from the GNPS .MSP file:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_msp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convertMsp2Spectra.html">convertMsp2Spectra</a></span><span class="op">(</span><span class="va">msp2spectra</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="binning-and-calculation-of-similarity-matrix">Binning and calculation of similarity matrix<a class="anchor" aria-label="anchor" href="#binning-and-calculation-of-similarity-matrix"></a>
</h2>
<div class="section level3">
<h3 id="workflow-for-tissue-data-set-using-fragment-ions">Workflow for <code>tissue</code> data set using fragment ions<a class="anchor" aria-label="anchor" href="#workflow-for-tissue-data-set-using-fragment-ions"></a>
</h3>
<div class="section level4">
<h4 id="calculation-of-the-similarity-matrix">Calculation of the similarity matrix<a class="anchor" aria-label="anchor" href="#calculation-of-the-similarity-matrix"></a>
</h4>
<p>The similarity matrix can be obtained by by the <code>Spectra</code>
package function <code>compareSpectra</code> which takes a
<code>Spectra</code> object and a function for the similarity
calculation as input.</p>
<p>The <code>MetCirc</code> package uses functions from the
<code>Spectra</code> package to calculate pair-wise similarities between
MS/MS features. The user can select the function (via <code>FUN</code>)
how to calculate the similarity. The function <code>ndotproduct</code>
from the <code>MsCoreUtils</code> package calculates the similarity
coefficient between two MS/MS features using the normalised dot product
(NDP). For a considered MS/MS pair, peak intensities of shared m/z
values for precursor/fragment ions are employed as weights <span class="math inline">\(W_{S1, i}\)</span> and <span class="math inline">\(W_{S1, i}\)</span> within the following
formula:</p>
<p><span class="math display">\[\begin{equation*}
    NDP = \frac{\sum(W_{S1, i} \cdot W_{S2, i}) ^ 2}{ \sum(W_{S1, i} ^
2) * \sum(W_{S2, i} ^ 2) },
\end{equation*}\]</span></p>
<p>with S1 and S2 the spectra 1 and 2, respectively, of the i<span class="math inline">\(th\)</span> of j common peaks differing by the
tolerance parameter specified in <code>compareSpectra</code>’s argument
<code>binSize</code>.</p>
<p>Weights are calculated according to <span class="math inline">\(W = [
peak~intensity] ^{m} \cdot [m/z]^n\)</span>, with m = 0.5 and n = 2 as
default values as suggested by MassBank. For further information see
<span class="citation">Li, Baldwin, and Gaquerel (2015)</span>.</p>
<p>Similarly, the function <code>neutralloss</code> takes into account
neutral losses between precursor m/z values and all fragments.</p>
<p>Alternatively, the user can specify a custom-defined function to
calculate similarities between MS/MS features or use an implemented
function in <code>Spectra</code>. The function
<code>compareSpectra</code> returns a symmetrical squared similarity
matrix with pair-wsie similarity coefficients between MS/MS
features.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## similarity Matrix </span></span>
<span><span class="va">similarityMat</span> <span class="op">&lt;-</span> <span class="fu">Spectra</span><span class="fu">::</span><span class="fu">compareSpectra</span><span class="op">(</span><span class="va">sps_tissue</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,<span class="op">]</span>, </span>
<span>    FUN <span class="op">=</span> <span class="fu">MsCoreUtils</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">ndotproduct</a></span>, ppm <span class="op">=</span> <span class="fl">10</span>, m <span class="op">=</span> <span class="fl">0.5</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">similarityMat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">similarityMat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sps_tissue</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span></span></code></pre></div>
<p><code>compareSpectra</code> returns a square matrix; in a next step,
we add the names of the <code>Spectra</code> MS/MS features as column
and row names. The entries of the returned matrix have to be similarites
cores ranging between 0 and 1 that are the pair-wise similarities
between the MS/MS features.</p>
</div>
<div class="section level4">
<h4 id="clusteringvisualisation">Clustering/visualisation<a class="anchor" aria-label="anchor" href="#clusteringvisualisation"></a>
</h4>
<p>At this stage, we would like to visualize the pair-wise similarities
of MS/MS features after clustering them. Many functions are available to
cluster features such as <code>hclust</code> from <code>stats</code>,
<code>Mclust</code> from <code>mclust</code> or <code>hcluster</code>
from <code>amap</code>. We would like to use the latter to cluster
similar features. To cluster features and visualize the result (see
figure <span class="math inline">\(\ref{fig:cluster}\)</span>) we
enter:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load package amap</span></span>
<span><span class="va">hClustMSP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/amap/man/hcluster.html" class="external-link">hcluster</a></span><span class="op">(</span><span class="va">similarityMat</span>, method<span class="op">=</span><span class="st">"spearman"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## visualize clusters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hClustMSP</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, xlab<span class="op">=</span><span class="st">""</span>, sub<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p>To promote readibility we will not show labels. These can be printed
to the ~console by
<code>colnames(similarityMat)[hClustMSP\$order]</code>.</p>
</div>
<div class="section level4">
<h4 id="extraction-of-highly-related-features-using-clustering">Extraction of highly-related features using clustering<a class="anchor" aria-label="anchor" href="#extraction-of-highly-related-features-using-clustering"></a>
</h4>
<p>Within the <code>R</code> session the similarity matrix can be
truncated by using the above-mentioned functions to retrieve a
similarity matrix that contains highly-related MS/MS features. For
instance, this might be needed when we want to analyse modules of high
similarity, representing e.g. a certain metabolite class. By way of
example, we extract in the following all features from module 1 when
defining three modules in total and define a new similarity matrix of
highly-related features. This kind of matrix can be used in later
analysis steps, e.g. in the analysis with <code>shinyCircos</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define three clusters</span></span>
<span><span class="va">cutTreeMSP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html" class="external-link">cutree</a></span><span class="op">(</span><span class="va">hClustMSP</span>, k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## extract feature identifiers that belong to module 1</span></span>
<span><span class="va">module1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cutTreeMSP</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">cutTreeMSP</span><span class="op">)</span> <span class="op">==</span> <span class="st">"1"</span><span class="op">]</span> </span>
<span></span>
<span><span class="co">## create a new similarity matrix that contains only highly related features</span></span>
<span><span class="va">similarityMat_module1</span> <span class="op">&lt;-</span> <span class="va">similarityMat</span><span class="op">[</span><span class="va">module1</span>, <span class="va">module1</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="visualisation-using-the-shinycirclize-framework">Visualisation using the <code>shiny</code>/<code>circlize</code>
framework<a class="anchor" aria-label="anchor" href="#visualisation-using-the-shinycirclize-framework"></a>
</h2>
<p><code>MetCirc</code>’s main functionality is to visualize
metabolomics data, exploring it interactively and annotate unknown
features based on similarity to other (known) features. One of the key
features of the implemented interactive framework is, that groups can be
compared. A group specifies the affiliation of the sample: it can be any
biological identifier relevant to the comparitive experiment conducted,
e.g. it can be a specific tissue, different times, different species,
etc. The visualisation tools implemented in <code>MetCirc</code> allow
then to display similarity between precursor ions between and/or within
groups.</p>
<p><code>shinyCircos</code> uses the function<code>createLinkDf</code>
which selects these precursor ions that have a similarity score (e.g. a
normalised dot product) within the range defined by <code>lower</code>
and <code>higher</code> to a precursor ion. Internally,
in<code>shinyCircos</code>,<code>createLinkDf</code> will be called to
produce a data.frame with link information based on the given
thresholds.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linkDf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createLinkDf.html">createLinkDf</a></span><span class="op">(</span>similarityMatrix <span class="op">=</span> <span class="va">similarityMat</span>, sps <span class="op">=</span> <span class="va">sps_tissue</span>,</span>
<span>    condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SPL"</span>, <span class="st">"LIM"</span>, <span class="st">"ANT"</span>, <span class="st">"STY"</span><span class="op">)</span>, lower <span class="op">=</span> <span class="fl">0.5</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>As we have calculated similarity coefficients between precursors, we
would like to visualize these connections interactively and explore the
data. The <code>MetCirc</code> package
implements<code>shinyCircos</code> that allows for such kind of
exploration. It is based on the <code>shiny</code> and on the
<code>circlize</code> <span class="citation">(Gu et al. 2014)</span>
framework. Inside of<code>shinyCircos</code> information of precursor
ions are displayed by (single-) clicking over precursors. Precursors can
also be permanently selected by double-clicking on them. The similarity
coefficients can be thresholded by changing the slider input. Also, on
the sidebar panel, the type of link to be displayed can be selected:
should only links between groups be displayed, should only links within
groups be displayed or should all links be displayed? Ordering inside of
groups can be changed by selecting the respective option in the sidebar
panel. Momentarily, there are options to reorder features based on
clustering, the m/z or the retention time of the precursor ion. In the
“Appearance” tab, the size of the plot can be changed, as well as the
precision of the displayed values for the m/z and retention time values.
Please note, that the precision will only be changed in the text output
(not in the graphical output). Also, the user can decide if the legend
is displayed or not.</p>
<p>On exiting the shiny application via the exit button in the sidebar
panel, selected precursors will be returned which are allocated here to
<code>selectedFeatures</code>. <code>selectedFeatures</code> is a vector
of the precursor names.</p>
<p>By way of example, we would like to analyse the tissue data set
focusing on the tissues “SPL”, “LIM”, “ANT” and “STY”.</p>
<p>To start the shiny app, run</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selectedFeatures</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shinyCircos.html">shinyCircos</a></span><span class="op">(</span><span class="va">similarityMat</span>, sps <span class="op">=</span> <span class="va">sps_tissue</span>, </span>
<span>    condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LIM"</span>, <span class="st">"ANT"</span>, <span class="st">"STY"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>in the console. This will load information stored in the
<code>Spectra</code> object <code>sps_tissue</code> to the
<code>shinyCircos</code> interface. Information (metabolite names and
class, adduct ion name and further information) will be printed to the
interface when (single-)clicking on MS/MS features. Since this
<code>Spectra</code> object did not contain any information about
metabolite names, class, adduct ion name and further information,
initally all fields for these instances are set to “Unkwown”. Note, that
on the sidebar on the right side text fields will appear, that allow for
changing the annotation of the selected feature. Click “update
annotation” to save the changes to the <code>Spectra</code>-object. On
exiting <code>shinyCircos</code> via the exit button, selected
precursors and the (updated) <code>Spectra</code>-object will be
returned to the console. In the example above, enter
<code>selectedFeatures$sps</code> to retrieve the <code>Spectra</code>
object with updated annotation.</p>
<p><code>MetCirc</code> allows also to create such figures outside of an
interactive context, which might be helpful to create figures and export
them e.g. in .pdf or .jpeg format.<code>shinyCircos</code> does
currently not support to export figures as they can be easily rebuilt
outside of <code>shinyCircos</code>; building figures outside of the
interactive context also promotes reproducibility of such figures.</p>
<p>To rebuild the figure in a non-interactive environment, run</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## order similarity matrix according to retention time</span></span>
<span><span class="va">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SPL"</span>, <span class="st">"LIM"</span>, <span class="st">"ANT"</span>, <span class="st">"STY"</span><span class="op">)</span></span>
<span><span class="va">simM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orderSimilarityMatrix.html">orderSimilarityMatrix</a></span><span class="op">(</span>similarityMatrix <span class="op">=</span> <span class="va">similarityMat</span>, </span>
<span>    sps <span class="op">=</span> <span class="va">sps_tissue</span>, type <span class="op">=</span> <span class="st">"retentionTime"</span>, group <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">groupname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">simM</span><span class="op">)</span></span>
<span><span class="va">inds</span> <span class="op">&lt;-</span> <span class="fu">MetCirc</span><span class="fu">:::</span><span class="fu"><a href="../reference/spectraCondition.html">spectraCondition</a></span><span class="op">(</span><span class="va">sps_tissue</span>, </span>
<span>    condition <span class="op">=</span> <span class="va">condition</span><span class="op">)</span></span>
<span><span class="va">inds_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">inds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">inds_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">groupname</span>, <span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">inds_match</span> <span class="op">&lt;-</span> <span class="va">inds_match</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">inds_match</span><span class="op">)</span><span class="op">]</span>; <span class="va">x</span><span class="op">[</span><span class="va">inds_match</span><span class="op">]</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">inds_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">inds_match</span><span class="op">)</span>, </span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">inds_match</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">condition</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>, <span class="va">inds_match</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">inds_cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">inds_cond</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create link matrix</span></span>
<span><span class="va">linkDf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createLinkDf.html">createLinkDf</a></span><span class="op">(</span>similarityMatrix <span class="op">=</span> <span class="va">simM</span>, sps <span class="op">=</span> <span class="va">sps_tissue</span>, </span>
<span>    condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SPL"</span>, <span class="st">"LIM"</span>, <span class="st">"ANT"</span>, <span class="st">"STY"</span><span class="op">)</span>, lower <span class="op">=</span> <span class="fl">0.9</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## cut link matrix (here: only display links between groups)</span></span>
<span><span class="va">linkDf_cut</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cutLinkDf.html">cutLinkDf</a></span><span class="op">(</span>linkDf <span class="op">=</span> <span class="va">linkDf</span>, type <span class="op">=</span> <span class="st">"inter"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## set circlize paramters</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/circos.par.html" class="external-link">circos.par</a></span><span class="op">(</span>gap.degree <span class="op">=</span> <span class="fl">0</span>, cell.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>    track.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## here set indSelected arbitrarily</span></span>
<span><span class="va">indSelected</span> <span class="op">&lt;-</span> <span class="fl">14</span></span>
<span><span class="va">selectedFeatures</span> <span class="op">&lt;-</span> <span class="va">inds_cond</span><span class="op">[</span><span class="va">indSelected</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## actual plotting</span></span>
<span><span class="fu"><a href="../reference/plotCircos.html">plotCircos</a></span><span class="op">(</span><span class="va">inds_cond</span>, <span class="va">linkDf_cut</span>, initialize <span class="op">=</span> <span class="cn">TRUE</span>, featureNames <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    cexFeatureNames <span class="op">=</span> <span class="fl">0.2</span>, groupSector <span class="op">=</span> <span class="cn">TRUE</span>, groupName <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    links <span class="op">=</span> <span class="cn">FALSE</span>, highlight <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/highlight.html">highlight</a></span><span class="op">(</span>groupname <span class="op">=</span> <span class="va">inds_cond</span>, ind <span class="op">=</span> <span class="va">indSelected</span>, linkDf <span class="op">=</span> <span class="va">linkDf_cut</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot without highlighting</span></span>
<span><span class="fu"><a href="../reference/plotCircos.html">plotCircos</a></span><span class="op">(</span><span class="va">inds_cond</span>, <span class="va">linkDf_cut</span>, initialize <span class="op">=</span> <span class="cn">TRUE</span>, featureNames <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    cexFeatureNames <span class="op">=</span> <span class="fl">0.2</span>, groupSector <span class="op">=</span> <span class="cn">TRUE</span>, groupName <span class="op">=</span> <span class="cn">FALSE</span>, links <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    highlight <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level3">
<h3 class="unnumbered" id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h3>
<p>All software and respective versions to build this vignette are
listed here:</p>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 20.04.5 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3</span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] MsCoreUtils_1.9.2    MetCirc_1.27.2       Spectra_1.7.3       </span></span>
<span><span class="co">##  [4] ProtGenerics_1.29.1  BiocParallel_1.31.13 S4Vectors_0.35.4    </span></span>
<span><span class="co">##  [7] BiocGenerics_0.43.4  shiny_1.7.2          scales_1.2.1        </span></span>
<span><span class="co">## [10] circlize_0.4.15      amap_0.8-18          knitr_1.40          </span></span>
<span><span class="co">## [13] BiocStyle_2.25.0    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] Rcpp_1.0.9          rprojroot_2.0.3     digest_0.6.29      </span></span>
<span><span class="co">##  [4] utf8_1.2.2          mime_0.12           R6_2.5.1           </span></span>
<span><span class="co">##  [7] evaluate_0.17       ggplot2_3.3.6       pillar_1.8.1       </span></span>
<span><span class="co">## [10] GlobalOptions_0.1.2 rlang_1.0.6         jquerylib_0.1.4    </span></span>
<span><span class="co">## [13] rmarkdown_2.17      pkgdown_2.0.6.9000  textshaping_0.3.6  </span></span>
<span><span class="co">## [16] desc_1.4.2          stringr_1.4.1       munsell_0.5.0      </span></span>
<span><span class="co">## [19] compiler_4.2.1      httpuv_1.6.6        xfun_0.33          </span></span>
<span><span class="co">## [22] pkgconfig_2.0.3     systemfonts_1.0.4   shape_1.4.6        </span></span>
<span><span class="co">## [25] htmltools_0.5.3     tibble_3.1.8        bookdown_0.29      </span></span>
<span><span class="co">## [28] IRanges_2.31.2      codetools_0.2-18    fansi_1.0.3        </span></span>
<span><span class="co">## [31] later_1.3.0         MASS_7.3-58.1       grid_4.2.1         </span></span>
<span><span class="co">## [34] jsonlite_1.8.2      xtable_1.8-4        gtable_0.3.1       </span></span>
<span><span class="co">## [37] lifecycle_1.0.3     magrittr_2.0.3      cli_3.4.1          </span></span>
<span><span class="co">## [40] stringi_1.7.8       cachem_1.0.6        farver_2.1.1       </span></span>
<span><span class="co">## [43] fs_1.5.2            promises_1.2.0.1    bslib_0.4.0        </span></span>
<span><span class="co">## [46] vctrs_0.4.2         ellipsis_0.3.2      ragg_1.2.3         </span></span>
<span><span class="co">## [49] tools_4.2.1         glue_1.6.2          purrr_0.3.5        </span></span>
<span><span class="co">## [52] parallel_4.2.1      fastmap_1.1.0       yaml_2.3.5         </span></span>
<span><span class="co">## [55] clue_0.3-61         colorspace_2.0-3    cluster_2.1.4      </span></span>
<span><span class="co">## [58] BiocManager_1.30.18 memoise_2.0.1       sass_0.4.2</span></span></code></pre>
</div>
<div class="section level3">
<h3 class="unnumbered" id="neutral-losses">Neutral losses<a class="anchor" aria-label="anchor" href="#neutral-losses"></a>
</h3>

</div>
<div class="section level3">
<h3 class="unnumbered" id="bibliography">Bibliography<a class="anchor" aria-label="anchor" href="#bibliography"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Gu2014" class="csl-entry">
Gu, Z., L. Gu, R. Eils, M. Schlesner, and B. Brors. 2014.
<span>“Circlize Implements and Enhances Circular Visualization in
r.”</span> <em>Bioinformatics</em> 30: 2811–12. <a href="https://doi.org/10.1093/bioinformatics/btu393" class="external-link">https://doi.org/10.1093/bioinformatics/btu393</a>.
</div>
<div id="ref-Krzywinkski2009" class="csl-entry">
Krzywinski, M. I., J. Schein, I. Birol, J. Connors, R. Gascoyne, D.
Horsman, S. J. Jones, and M. A. Marra. 2009. <span>“Circos: An
Information Aesthetic for Comparative Genomics.”</span> <em>Genome
Research</em> 19: 1639–45. <a href="https://doi.org/10.1101/gr.092759.109" class="external-link">https://doi.org/10.1101/gr.092759.109</a>.
</div>
<div id="ref-Li2015" class="csl-entry">
Li, D., I. T. Baldwin, and E. Gaquerel. 2015. <span>“Navigating Natural
Variation in Herbivory-Induced Secondary Metabolism in Coyote Tobacco
Populations Using MS/MS Structural Analysis.”</span> <em>PNAS</em> 112:
E4147–55. <a href="https://doi.org/10.1073/pnas.1503106112" class="external-link">https://doi.org/10.1073/pnas.1503106112</a>.
</div>
<div id="ref-Watrous2012" class="csl-entry">
Watrous, J., P. Roach, T. Alexandrov, B. S. Heath, J. Y. Yanga, R. D.
Kersten, M. van der Voort, et al. 2012. <span>“Mass Spectral Molecular
Networking of Living Microbial Colonies.”</span> <em>PNAS</em> 109:
E1743–52. <a href="https://doi.org/10.1073/pnas.1203689109" class="external-link">https://doi.org/10.1073/pnas.1203689109</a>.
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Thomas Naake, Emmanuel Gaquerel.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
